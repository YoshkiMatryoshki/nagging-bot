name: deploy-step1

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment suffix (e.g. dev, prod)
        required: true
        default: dev
      backup_db:
        description: Backup DB before deploy (true/false)
        required: true
        default: "false"

permissions:
  contents: read

jobs:
  build_and_copy:
    runs-on: ubuntu-latest
    env:
      ROOT_PATH: /opt/services/naggingbot-${{ github.event.inputs.environment }}
      SERVICE_NAME: naggingbot-${{ github.event.inputs.environment }}
      BINARY_NAME: naggingbot
      SERVICE_USER: cringe-deploy
      BACKUP_DB: ${{ github.event.inputs.backup_db }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build linux binary
        run: GOOS=linux GOARCH=amd64 go build -o ${BINARY_NAME} ./cmd/bot

      - name: Build .env from secrets
        run: |
          cat > .env <<EOF
          BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          DB_PATH=${ROOT_PATH}/shared/naggingbot.db
          POLL_INTERVAL=${{ secrets.POLL_INTERVAL }}
          POLL_TIMEOUT=${{ secrets.POLL_TIMEOUT }}
          SCHEDULER_INTERVAL=${{ secrets.SCHEDULER_INTERVAL }}
          EOF

      - name: Build systemd service file
        run: |
          cat > ${SERVICE_NAME}.service <<EOF
          [Unit]
          Description=NaggingBot Telegram Reminder
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=${SERVICE_USER}
          Group=${SERVICE_USER}
          WorkingDirectory=${ROOT_PATH}/current
          ExecStartPre=/usr/bin/ln -sfn ${ROOT_PATH}/shared/.env ${ROOT_PATH}/current/.env
          ExecStart=${ROOT_PATH}/current/${BINARY_NAME}
          EnvironmentFile=${ROOT_PATH}/shared/.env
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Prepare remote deploy script
        run: cp scripts/deploy_remote.sh deploy_remote.sh

      - name: Copy binary to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "${{ env.BINARY_NAME }}"
          target: "${{ env.ROOT_PATH }}/upload/"

      - name: Copy env to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: ".env"
          target: "${{ env.ROOT_PATH }}/shared/"

      - name: Copy service file to server (shared)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "${{ env.SERVICE_NAME }}.service"
          target: "${{ env.ROOT_PATH }}/shared/"

      - name: Copy remote deploy script to server (shared)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "deploy_remote.sh"
          target: "${{ env.ROOT_PATH }}/shared/"

      - name: Run remote deploy script
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
        run: |
          set -euo pipefail
          umask 077
          KEY_FILE="$(mktemp)"
          trap 'rm -f "${KEY_FILE}"' EXIT
          # Normalize line endings and keep trailing newline for OpenSSH parser.
          printf '%s\n' "${SSH_KEY}" | sed 's/\r$//' > "${KEY_FILE}"
          chmod 600 "${KEY_FILE}"
          if ! ssh-keygen -y -f "${KEY_FILE}" >/dev/null 2>&1; then
            echo "Invalid SSH_KEY secret: expected an OpenSSH private key block." >&2
            exit 1
          fi
          ssh -o StrictHostKeyChecking=accept-new -i "${KEY_FILE}" -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" \
            "chmod +x '${ROOT_PATH}/shared/deploy_remote.sh' && '${ROOT_PATH}/shared/deploy_remote.sh' '${ROOT_PATH}' '${SERVICE_NAME}' '${BINARY_NAME}' '${BACKUP_DB}'"
